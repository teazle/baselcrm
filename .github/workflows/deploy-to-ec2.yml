name: Deploy to EC2

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual trigger

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT || 22 }}
          script: |
            # Expand ~ to home directory and set deploy path
            DEPLOY_PATH="${{ secrets.EC2_DEPLOY_PATH || '~/Baselrpacrm' }}"
            DEPLOY_PATH="${DEPLOY_PATH/#\~/$HOME}"
            
            echo "ðŸ“ Deploy path: $DEPLOY_PATH"
            cd "$DEPLOY_PATH" || { echo "âŒ Error: Cannot cd to $DEPLOY_PATH"; exit 1; }
            
            # Verify we're in a git repository
            if [ ! -d .git ]; then
              echo "âŒ Error: Not a git repository in $DEPLOY_PATH"
              exit 1
            fi
            
            # Pull latest changes
            echo "ðŸ“¥ Pulling latest changes from Git..."
            git fetch origin || { echo "âš ï¸  Warning: git fetch failed"; }
            
            # Get current branch
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")
            echo "ðŸŒ¿ Current branch: $CURRENT_BRANCH"
            
            # Reset to latest from origin
            git reset --hard origin/main 2>/dev/null || git reset --hard origin/master 2>/dev/null || {
              echo "âš ï¸  Warning: git reset failed, trying pull instead"
              git pull origin "$CURRENT_BRANCH" || true
            }
            
            # Check if package.json changed (compare with previous commit if available)
            echo "ðŸ“¦ Checking for dependency updates..."
            PACKAGE_CHANGED=false
            
            # Try to detect changes in package files
            if git rev-parse HEAD@{1} >/dev/null 2>&1; then
              # Previous commit exists, check diff
              if git diff HEAD@{1} HEAD --name-only 2>/dev/null | grep -q "package.json\|package-lock.json"; then
                PACKAGE_CHANGED=true
              fi
            else
              # No previous commit, check if package files exist and are tracked
              if git ls-files --error-unmatch package.json package-lock.json >/dev/null 2>&1; then
                # Files are tracked, check if they changed in current commit
                if git diff HEAD --name-only 2>/dev/null | grep -q "package.json\|package-lock.json"; then
                  PACKAGE_CHANGED=true
                fi
              fi
            fi
            
            if [ "$PACKAGE_CHANGED" = true ]; then
              echo "ðŸ“¦ Installing/updating dependencies..."
              npm install || { echo "âš ï¸  Warning: npm install failed"; }
              npm run install-browsers || { echo "âš ï¸  Warning: install-browsers failed"; }
            else
              echo "â„¹ï¸  No dependency changes detected"
            fi
            
            # Build and deploy Next.js CRM app
            if [ -d apps/crm ]; then
              echo "ðŸ—ï¸  Building CRM app (apps/crm)..."
              cd apps/crm
              
              # STOP any existing process on port 3000 (dev or prod)
              echo "ðŸ›‘ Stopping any process on port 3000..."
              if command -v pm2 &> /dev/null; then
                pm2 delete crm 2>/dev/null || true
                pm2 delete all 2>/dev/null || true
              fi
              # Kill any remaining process on port 3000
              sudo fuser -k 3000/tcp 2>/dev/null || true
              sleep 2
              
              # Install CRM dependencies if needed
              if [ ! -d node_modules ] || [ "$PACKAGE_CHANGED" = true ]; then
                echo "ðŸ“¦ Installing CRM dependencies..."
                npm install || { echo "âš ï¸  Warning: CRM npm install failed"; }
              fi
              
              # Build the Next.js app for production
              echo "ðŸ—ï¸  Running production build..."
              npm run build || { echo "âŒ CRM build failed"; exit 1; }
              
              # Verify build exists
              if [ ! -d .next ]; then
                echo "âŒ .next folder not found after build!"
                exit 1
              fi
              echo "âœ… Build successful - .next folder exists"
              
              # Start CRM with PM2 in production mode
              if command -v pm2 &> /dev/null; then
                echo "ðŸš€ Starting CRM in production mode with PM2..."
                pm2 start ecosystem.config.cjs
                pm2 save
                sleep 3
                pm2 status
              else
                echo "âš ï¸  PM2 not installed - starting directly..."
                nohup npm start > /tmp/crm.log 2>&1 &
              fi
              
              cd "$DEPLOY_PATH"
            fi
            
            echo "âœ… Deployment complete!"
            
            # Show current status
            echo "ðŸ“Š Current status:"
            echo "  Branch: $(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'unknown')"
            echo "  Commit: $(git log -1 --oneline 2>/dev/null || echo 'unknown')"
            if command -v pm2 &> /dev/null; then
              echo "  PM2 Status:"
              pm2 status || true
            fi
